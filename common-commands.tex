\documentclass[
    b5paper,
    pagesize,
    10pt,
    bibtotoc,
    normalheadings,
    twoside,
    openany,
    chapterprefix,
    DIV=9
]{scrbook}

%=============== Packages ================
% Fonts
\usepackage[T1]{fontenc}
\usepackage[utf8]{inputenc}
\usepackage{tgpagella}
\usepackage{mathpazo}

% Math formatting
\usepackage{mathtools}
\usepackage{amsfonts}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{amsthm}
\usepackage{thmtools}

% Page formatting, colour and images
\usepackage[inner=1.5cm, outer=2.5cm, vmargin=2.5cm]{geometry}
\usepackage{graphicx}
\usepackage{tocloft}
\usepackage[x11names]{xcolor}
\usepackage{wrapfig}
\usepackage{parskip}
\usepackage{fancyhdr}
\usepackage{emptypage}
\usepackage{imakeidx}
\usepackage{mdframed}
\usepackage{eso-pic}

% Hyperlinks and references
\usepackage[breaklinks]{hyperref}
\usepackage[capitalise, nameinlink]{cleveref}
\usepackage{crossreftools}
\usepackage[
    backend=bibtex,
    style=alphabetic,
    sorting=ynt
]{biblatex}

% Miscellaneous
\usepackage{multicol}
\usepackage{enumitem}

%============== Resources ================
\addbibresource{abstract-algebra.bib}

%============= Formatting ================
\linespread{1.05}

%============ Redefinitions ==============
\let\oldemptyset\emptyset
\let\emptyset\varnothing

\let\totient\varphi

\renewcommand{\vert}{ \ \vline \ }
\newcommand{\vertalt}{ \ | \ }

\newcommand{\myref}[1]{\textbf{\crthypercref{#1}}}
\newcommand{\myreffigures}[1]{\textbf{\cref{#1}}}

\renewcommand{\qedsymbol}{\ensuremath{\blacksquare}}
\newcommand{\qedsymbolalt}{\ensuremath{\square}}

%=========== Theorem Things ==============
% 'Results' declarations
\newcommand{\makenewresultstyle}[2]{
    \declaretheoremstyle[
        headfont=\normalfont\bfseries,
        bodyfont=\normalfont,
        notefont=\normalfont\bfseries\itshape,
        spaceabove=0pt,  % Space between previous paragraph and current block
        spacebelow=0pt,  % Space between current block and next paragraph
        mdframed={
            skipabove=3pt,  % Space between top of block and beginning of coloured frame
            skipbelow=3pt,  % Space between bottom of block and beginning of coloured frame
            hidealllines=true,
            backgroundcolor=#2,
            usetwoside=false,  % Needed for `leftmargin` and `rightmargin` to work
            leftmargin=-5pt,
            rightmargin=-5pt,
            innerleftmargin=5pt,
            innerrightmargin=5pt
        }
    ]{#1-style}
}

\makenewresultstyle{theorem}{DarkSeaGreen2}
\declaretheorem[name=Theorem,style=theorem-style,within=section]{theorem}
\renewcommand*{\thetheorem}{\ZeroRoman{part}.\arabic{chapter}.\arabic{section}.\arabic{theorem}}

\makenewresultstyle{lemma}{Honeydew2}
\declaretheorem[style=lemma-style,sibling=theorem]{lemma}

\makenewresultstyle{proposition}{Honeydew1}
\declaretheorem[style=proposition-style,sibling=theorem]{proposition}

\makenewresultstyle{corollary}{DarkSeaGreen1}
\declaretheorem[style=corollary-style,sibling=theorem]{corollary}

\makenewresultstyle{definition}{LightCyan1}
\declaretheorem[style=definition-style,sibling=theorem]{definition}

\makenewresultstyle{axiom}{Thistle2}
\declaretheorem[style=axiom-style,sibling=theorem]{axiom}

% 'Questions' declarations
\declaretheoremstyle[
    headfont=\normalfont\bfseries,
    bodyfont=\normalfont,
    spaceabove=5pt,  % Space between previous paragraph and current block
    prefoothook={\vspace{5pt}},
    mdframed={
        skipabove=10pt,  % Space between top of block and beginning of frame
        skipbelow=10pt,  % Space between bottom of block and beginning of frame
        usetwoside=false,
        innerleftmargin=10pt,
        innerrightmargin=10pt
    }
]{exercise-style}
\declaretheorem[style=exercise-style,within=chapter]{exercise}
\renewcommand*{\theexercise}{\ZeroRoman{part}.\arabic{chapter}.\arabic{exercise}}

\declaretheoremstyle[
    headfont=\normalfont\bfseries,
    bodyfont=\normalfont,
    notefont=\normalfont\bfseries\itshape,
    spaceabove=0pt,  % Space between previous paragraph and current block
    spacebelow=0pt,  % Space between current block and next paragraph
]{problem-style}
\declaretheorem[name=Problem,style=problem-style,within=chapter]{problem}
\renewcommand*{\theproblem}{\ZeroRoman{part}.\arabic{chapter}.\arabic{problem}}

% Miscellaneous declarations
\declaretheoremstyle[
    headfont=\normalfont\bfseries,
    bodyfont=\normalfont
]{general-style}
\declaretheorem[style=general-style,sibling=theorem]{example}
\declaretheorem[style=general-style,numbered=no]{remark}

%============ Environments ===============
\newenvironment{questions}
{\begin{enumerate}[label=\textbf{\arabic*.}]}
{\end{enumerate}}

\newenvironment{partquestions}[1]
{\begin{enumerate}[label=\textbf{(#1)}]}
{\end{enumerate}}

%=========== Custom Commands =============
\newcommand{\ZeroRoman}[1]{\ifcase\value{#1}\relax0\else\Roman{#1}\fi}  % Roman numeral

\newcommand{\code}[1]{\texttt{#1}}  % Code block

\newcommand{\lcm}{\mathrm{lcm}}  % Lowest common multiple function
\newcommand{\sgn}{\mathrm{sgn}}  % Signum function

\newcommand{\im}{\mathrm{im}\;}  % Image of a function
\newcommand{\id}{\mathrm{id}}    % Identity function

%======== Custom Chapter Styling =========
\makeatletter
\renewcommand{\chaptermark}[1]{
    \markboth{\if@mainmatter\chapapp~\thechapter.\ \fi#1}{}
}

\renewcommand*{\chapterformat}{
  \MakeUppercase{\chapapp\nobreakspace\thechapter}
}

\renewcommand*{\chapterlineswithprefixformat}[3]{
    \Ifstr{#1}{chapter}{
        \vspace{-60px}
        \Ifstr{#2}{\empty}{\vspace{40px}}{\raggedleft#2}
        \vspace{-15px}
        \rule{\linewidth}{1pt}\par\nobreak
        \centering{#3}
        \vspace{-10px}
        \rule{\linewidth}{1pt}\par\nobreak
        \vspace{-10px}
    }{#2#3}
}
\makeatother

%======== Figure Caption Format ==========
\usepackage[labelfont=bf]{caption}
\DeclareCaptionLabelFormat{custom}{#1 \ZeroRoman{part}.#2.}
\captionsetup{labelformat=custom,labelsep=space}

%============ Custom Header ==============
\fancypagestyle{plain}{\fancyhf{}\renewcommand{\headrulewidth}{0pt}}  % To clear page numbers from footer, and header line at the start of every chapter

\pagestyle{fancy}
\fancyhf{}  % Clear header/footer

\fancyhead[LE,RO]{\thepage}
\fancyhead[LO,RE]{\textit{\nouppercase\leftmark}}

%========= Customise TOC Heading =========
\makeatletter
\def\createtoc{
    \renewcommand\tableofcontents{
        \chapter*{\contentsname}
        \@starttoc{toc}
    }
    \tableofcontents
}
\makeatother

%======= Customise Draft Watermark =======
\newcommand{\setasdraft}{
    \usepackage{draftwatermark}
    \SetWatermarkLightness{0.95}
    \SetWatermarkScale{1}
}

%============= Index Pages ===============
\usepackage[
    totoc,
    columnsep=20pt,
    hangindent=8pt,
    subindent=20pt,
    subsubindent=30pt
]{idxlayout}

\makeindex[options= -s index-style.ist]

%======= Bibliography Formatting =========
% These two lines are here to ensure that URLs do not exceed the page by too much
\setcounter{biburllcpenalty}{7000}
\setcounter{biburlucpenalty}{8000}
