\documentclass[
    b5paper,
    pagesize,
    10pt,
    bibtotoc,
    normalheadings,
    twoside,
    openany,
    chapterprefix,
    DIV=9
]{scrbook}

\usepackage[T1]{fontenc}
\usepackage[utf8]{inputenc}
\usepackage{tgpagella}
\usepackage{mathpazo}
\usepackage{tocloft}
\usepackage{mathtools}
\usepackage{amsfonts}
\usepackage{enumitem}
\usepackage{amsmath}
\usepackage{amsthm}
\usepackage{amssymb}
\usepackage[inner=1.5cm, outer=2.5cm, vmargin=2.5cm]{geometry}
\usepackage{graphicx}
\usepackage{wrapfig}
\usepackage{parskip}
\usepackage{framed}
\usepackage{fancyhdr}
\usepackage{emptypage}
\usepackage{multicol}
\usepackage{imakeidx}
\usepackage[breaklinks]{hyperref}
\usepackage[capitalise, nameinlink]{cleveref}
\usepackage[x11names]{xcolor}
\usepackage{crossreftools}

\usepackage[
    backend=bibtex,
    style=alphabetic,
    sorting=ynt
]{biblatex}

%============== Resources ================
\addbibresource{abstract-algebra.bib}

%============= Formatting ================
\linespread{1.05}

%============ Redefinitions ==============
\let\oldemptyset\emptyset
\let\emptyset\varnothing

\let\totient\varphi

\renewcommand{\vert}{ \ \vline \ }
\newcommand{\vertalt}{ \ | \ }

\newcommand{\myref}[1]{\textbf{\crthypercref{#1}}}
\newcommand{\myreffigures}[1]{\textbf{\cref{#1}}}

\renewcommand{\qedsymbol}{\ensuremath{\blacksquare}}
\newcommand{\qedsymbolalt}{\ensuremath{\square}}

%=========== Theorem Styles ==============
\newtheoremstyle{theorem-style}
    {}           % Space above
    {}           % Space below
    {}           % Font to use in the theorem
    {0pt}        % Measure of space to indent
    {\bfseries}  % Name of the head font
    {.}          % Punctuation between head and body
    { }          % Space after theorem head; " " = normal inter-word space
    {\thmname{#1}\thmnumber{ #2}\textit{\thmnote{ (#3)}}}

\newtheoremstyle{definition-style}
    {}           % Space above
    {}           % Space below
    {}           % Font to use in the definition
    {0pt}        % Measure of space to indent
    {\bfseries}  % Name of the head font
    {.}          % Punctuation between head and body
    { }          % Space after theorem head; " " = normal inter-word space
    {\thmname{#1}\thmnumber{ #2}\textnormal{\thmnote{ (#3)}}}

\newtheoremstyle{exercise-style}
    {}           % Space above
    {}           % Space below
    {}           % Font to use in the exercise
    {0pt}        % Measure of space to indent
    {\bfseries}  % Name of the head font
    {.}          % Punctuation between head and body
    { }          % Space after theorem head; " " = normal inter-word space
    {\thmname{#1}\thmnumber{ #2}\textnormal{\thmnote{ (#3)}}}

%======== Theorem-Like Things ============
% 'Results' definitions
\theoremstyle{theorem-style}\newtheorem{theoremhidden}{Theorem}[section]
\renewcommand{\thetheoremhidden}{\ZeroRoman{part}.\arabic{chapter}.\arabic{section}.\arabic{theoremhidden}}

\theoremstyle{theorem-style}\newtheorem{lemmahidden}[theoremhidden]{Lemma}

\theoremstyle{theorem-style}\newtheorem{propositionhidden}[theoremhidden]{Proposition}

\theoremstyle{theorem-style}\newtheorem{corollaryhidden}[theoremhidden]{Corollary}

\theoremstyle{definition-style}\newtheorem{definitionhidden}[theoremhidden]{Definition}

\theoremstyle{definition-style}\newtheorem{axiomhidden}[theoremhidden]{Axiom}

% 'Questions' definitions
\theoremstyle{exercise-style}\newtheorem{exercisehidden}{Exercise}[chapter]
\renewcommand{\theexercisehidden}{\ZeroRoman{part}.\arabic{chapter}.\arabic{exercisehidden}}

\theoremstyle{definition}\newtheorem{problem}{Problem}[chapter]
\renewcommand{\theproblem}{\ZeroRoman{part}.\arabic{chapter}.\arabic{problem}}

% Miscellaneous definitions
\theoremstyle{definition}\newtheorem*{remark}{Remark}
\theoremstyle{definition}\newtheorem{examplehidden}[theoremhidden]{Example}

%============ Environments ===============
% 'Results' environments
\newcommand{\makeresultenv}[2]{
    \newenvironment{#1}
    {
        \noindent\begin{#1hidden}
        \setlength{\FrameSep}{5pt}
        \definecolor{shadecolor}{named}{#2}
        \begin{shaded}
    }
    {
        \end{shaded}
        \setlength{\FrameSep}{\fboxsep}
        \end{#1hidden}
    }
}

\makeresultenv{theorem}{DarkSeaGreen2}
\makeresultenv{lemma}{Honeydew2}
\makeresultenv{proposition}{Honeydew1}
\makeresultenv{corollary}{DarkSeaGreen1}

\makeresultenv{definition}{LightCyan1}
\makeresultenv{axiom}{Thistle2}

\newenvironment{exercise}
{
    \noindent\begin{exercisehidden}
    \setlength{\FrameSep}{10pt}
    \begin{framed}
}
{
    \end{framed}
    \setlength{\FrameSep}{\fboxsep}
    \end{exercisehidden}
}

% 'Questions' environments
\newenvironment{questions}
{\begin{enumerate}[label=\textbf{\arabic*.}]}
{\end{enumerate}}

\newenvironment{partquestions}[1]
{\begin{enumerate}[label=\textbf{(#1)}]}
{\end{enumerate}}

% Miscellaneous environments
\newenvironment{example}
{\begin{examplehidden}}
{\null\hfill\qedsymbolalt\end{examplehidden}}

\newenvironment{examplealt}
{\begin{examplehidden}}
{\end{examplehidden}}

%=========== Custom Commands =============
\newcommand{\ZeroRoman}[1]{\ifcase\value{#1}\relax0\else\Roman{#1}\fi}  % Roman numeral

\newcommand{\code}[1]{\texttt{#1}}  % Code block

\newcommand{\lcm}{\mathrm{lcm}}  % Lowest common multiple function
\newcommand{\sgn}{\mathrm{sgn}}  % Signum function

\newcommand{\im}{\mathrm{im}\;}  % Image of a function
\newcommand{\id}{\mathrm{id}}    % Identity function

%======== Custom Chapter Styling =========
\makeatletter
\renewcommand{\chaptermark}[1]{
    \markboth{\if@mainmatter\chapapp~\thechapter.\ \fi#1}{}
}

\renewcommand*{\chapterformat}{
  \MakeUppercase{\chapapp\nobreakspace\thechapter}
}

\renewcommand*{\chapterlineswithprefixformat}[3]{
    \Ifstr{#1}{chapter}{
        \vspace{-60px}
        \Ifstr{#2}{\empty}{\vspace{40px}}{\raggedleft#2}
        \vspace{-15px}
        \rule{\linewidth}{1pt}\par\nobreak
        \centering{#3}
        \vspace{-10px}
        \rule{\linewidth}{1pt}\par\nobreak
        \vspace{-10px}
    }{#2#3}
}
\makeatother

%======== Figure Caption Format ==========
\usepackage[labelfont=bf]{caption}
\DeclareCaptionLabelFormat{custom}{#1 \ZeroRoman{part}.#2.}
\captionsetup{labelformat=custom,labelsep=space}

%============ Custom Header ==============
\fancypagestyle{plain}{\fancyhf{}\renewcommand{\headrulewidth}{0pt}}  % To clear page numbers from footer, and header line at the start of every chapter

\pagestyle{fancy}
\fancyhf{}  % Clear header/footer

\fancyhead[LE,RO]{\thepage}
\fancyhead[LO,RE]{\textit{\nouppercase\leftmark}}

%========= Customise TOC Heading =========
\makeatletter
\def\createtoc{
    \renewcommand\tableofcontents{
        \chapter*{\contentsname}
        \@starttoc{toc}
    }
    \tableofcontents
}
\makeatother

%======= Customise Draft Watermark =======
\newcommand{\setasdraft}{
    \usepackage{draftwatermark}
    \SetWatermarkLightness{0.95}
    \SetWatermarkScale{1}
}

%============= Index Pages ===============
\usepackage[
    totoc,
    columnsep=20pt,
    hangindent=8pt,
    subindent=20pt,
    subsubindent=30pt
]{idxlayout}

\makeindex[options= -s index-style.ist]

%======= Bibliography Formatting =========
% These two lines are here to ensure that URLs do not exceed the page by too much
\setcounter{biburllcpenalty}{7000}
\setcounter{biburlucpenalty}{8000}
